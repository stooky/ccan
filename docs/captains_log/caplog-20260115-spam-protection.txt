================================================================================
CAPTAIN'S LOG - 2026-01-15 - Spam Protection Implementation
================================================================================

## The Problem

Forms were vulnerable to spam and scammers. Only protection was a honeypot field,
which catches the dumbest bots but nothing else. Needed invisible protection that
doesn't annoy legitimate customers with CAPTCHAs.

## What We Built

Multi-layer spam protection. All invisible to users. All configurable in config.yaml.

### Layer 1: Honeypot (already existed)
Hidden field that bots auto-fill. Humans never see it.

### Layer 2: Time-Based Validation (NEW)
- Frontend sets timestamp when form loads
- Backend checks: did they submit in under 3 seconds?
- Humans can't fill a form that fast. Bots can.
- Configurable: `security.min_submit_time` (default: 3 seconds)

### Layer 3: Rate Limiting (NEW - was in config but not enforced)
- Tracks IP submissions in `data/rate-limits.json`
- Blocks if too many requests in time window
- Auto-cleans expired entries
- Configurable: `security.rate_limit` (default: 10) and `rate_limit_window` (default: 3600 seconds)

### Layer 4: Content Filtering (NEW)
Checks message content for spam indicators:

**Excessive URLs:** More than 2 links = spam (configurable: `security.max_urls`)

**Spam Phrases:** Blocks messages containing:
- crypto/bitcoin/ethereum/nft
- seo services/rank your website
- casino/poker/slot machine
- viagra/cialis/pharmacy
- make money fast/earn money online
- nigerian prince/lottery winner
- etc. (full list in config.yaml)

**Excessive Caps:** Messages that are >75% uppercase get flagged

### Layer 5: Disposable Email Blocking (NEW)
Blocks throwaway email domains:
- mailinator.com, guerrillamail.com, tempmail.com
- 10minutemail.com, yopmail.com, etc.
- ~20 domains blocked by default, easy to add more

## Files Changed

```
src/components/ContactForm.astro      - Added _formLoadTime hidden field
src/components/TabbedContactForm.astro - Added _formLoadTime to both forms
api/contact.php                        - All the backend validation logic
config.yaml                            - New security settings section
README.md                              - Documentation
```

## Key Design Decisions

1. **Pretend success on spam rejection**
   Spammers get "Thank you for your message!" even when blocked.
   No feedback = no way to probe the filters.

2. **Spam logging**
   All rejections logged to `data/spam-log.json` with reason, IP, email, timestamp.
   Useful for analysis. Auto-truncates to last 500 entries when over 1000.

3. **No CAPTCHA**
   These invisible checks should catch 95%+ of spam.
   If it gets bad later, Cloudflare Turnstile is the fallback plan.

4. **Config-driven blocklists**
   Spam phrases and disposable domains live in config.yaml.
   Easy to add new ones without touching PHP code.

## Testing Notes

Can't fully test locally since PHP runs on server. Logic review:
- Time check: compares JS Date.now() (ms) with PHP microtime(true)*1000 (ms)
- Rate limit: file-based, cleans up on each request
- Content filter: case-insensitive, checks all text fields

## Admin Panel - Spam Tab

Added a "Spam" tab to the admin panel (`/api/admin.php`) to view blocked submissions:
- Shows total blocked count and today's count
- Filter by reason (honeypot, time check, content filter)
- Search by email or IP
- Expandable rows show full details (reason, email, IP, user agent, timestamp)
- Newest entries shown first

The spam log auto-rotates at 1000 entries (keeps last 500).

## What's NOT Protected

- Quote form (`api/quote.php`) - same spam checks should be added if needed

## Next Steps If Spam Persists

1. Add Cloudflare Turnstile (free, invisible CAPTCHA)
2. Implement email verification (send code, confirm to submit)
3. Block by country if attacks come from specific regions

---
Session: ~45 minutes
Result: 5-layer invisible spam protection, all configurable

================================================================================
UPDATE - 2026-01-16 - Advanced Bot Detection Added
================================================================================

## The Problem

Spam got through with gibberish content:
- Name: "RLuWJgVLqRmIFixr" (random characters)
- Email: "xoxob.a.ya.qo8.3@gmail.com" (suspicious dot pattern)
- Message: "txKSMOAQNXRvxXvezHI" (no real words)
- Phone: "5996424987" (invalid area code - 599 is Caribbean)

Basic filters didn't catch it because:
- No spam keywords
- Not a disposable email domain
- Waited 3+ seconds to submit
- Didn't fill honeypot

## What We Added

### 1. Gibberish Detection (entropy analysis)
Random strings have high entropy and lack common letter patterns.
- Checks: th, he, in, er, an, re, on, at... (common English bigrams)
- "txKSMOAQNXRvxXvezHI" has high entropy + no common patterns = blocked

### 2. Name Validation
Real names have:
- Vowels (~35-45% of letters)
- No more than 4 consecutive consonants
- Capitals only at start of words

"RLuWJgVLqRmIFixr" fails: random mid-word capitals, low vowel ratio

### 3. Phone Area Code Validation
Checks against list of valid Canadian area codes:
- 306, 639 (Saskatchewan)
- 403, 587, 780, 825 (Alberta)
- 204, 431 (Manitoba)
- 236, 250, 604, 672, 778 (BC)
- Plus Ontario, Quebec

"5996424987" fails: 599 not in valid list

### 4. Message Word Validation
Requires at least one real English word from a dictionary of ~150 common words
plus container/shipping-specific terms (quote, delivery, container, etc.)

"txKSMOAQNXRvxXvezHI" fails: zero dictionary matches

### 5. Gmail Dot Pattern
Bots often use gmail addresses with many dots: x.o.x.o.b@gmail.com
- Limit: 3+ dots in username = flagged
- Legitimate users rarely have this pattern

## Config Options (all in config.yaml)

```yaml
security:
  gibberish_detection: true
  name_validation: true
  phone_area_code_validation: true
  valid_area_codes: ["306", "639", ...]
  message_word_validation: true
  min_real_words: 1
  gmail_dot_limit: 3
```

## Files Changed

```
config.yaml       - New security settings
api/contact.php   - 4 new validation functions
README.md         - Updated security documentation
```

## The Spam That Triggered This

```
Name: RLuWJgVLqRmIFixr
Email: xoxob.a.ya.qo8.3@gmail.com
Phone: 5996424987
Message: txKSMOAQNXRvxXvezHI
IP: 185.220.101.131 (Tor exit node)
```

Would now be caught by:
- invalid_name:random_caps
- invalid_phone:invalid_area_code:599
- gibberish_message:no_real_words
- gmail_dot_pattern:4_dots

Any ONE of these would block it.

---
Session update: +30 minutes
Result: 10-layer invisible spam protection (basic 5 + advanced 5)
