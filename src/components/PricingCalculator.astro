---
/**
 * PricingCalculator - Interactive pricing estimator
 *
 * Helps customers get a quick price estimate based on their needs.
 * Encourages engagement and captures intent before contacting.
 */
import { siteConfig } from '../config/site';

interface Props {
  title?: string;
  showDelivery?: boolean;
}

const {
  title = "Get a Quick Price Estimate",
  showDelivery = true,
} = Astro.props;

// Get container pricing from config
const containers = siteConfig.products.containers;
const phoneLink = `tel:${siteConfig.contact.phone.replace(/\D/g, '')}`;
---

<div class="pricing-calculator bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
  <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
    <h3 class="text-lg font-bold text-gray-900">{title}</h3>
    <p class="text-sm text-gray-600 mt-1">Select your options below for an instant estimate</p>
  </div>

  <div class="p-6 space-y-6">
    <!-- Container Size -->
    <div>
      <label class="block text-sm font-medium text-gray-900 mb-3">1. Container Size</label>
      <div class="grid grid-cols-2 gap-3" id="calc-size-options">
        {containers.map((container, index) => (
          <label class={`calc-size-option relative flex cursor-pointer rounded-lg border p-4 hover:border-primary-500 focus-within:ring-2 focus-within:ring-primary-500 ${index === 1 ? 'border-primary-500 bg-primary-50' : 'border-gray-200 bg-white'}`}>
            <input
              type="radio"
              name="calc-size"
              value={container.slug}
              data-new-min={container.new?.min || 0}
              data-new-max={container.new?.max || 0}
              data-used-min={container.used?.min || 0}
              data-used-max={container.used?.max || 0}
              data-size={container.size}
              class="sr-only"
              checked={index === 1}
            />
            <span class="flex flex-1 flex-col">
              <span class="block text-sm font-semibold text-gray-900">{container.size}</span>
              <span class="mt-1 text-xs text-gray-500">
                {container.size === '9ft' && 'Compact'}
                {container.size === '20ft' && 'Most Popular'}
                {container.size === '40ft' && 'Max Space'}
                {container.size === '40ft HC' && 'Extra Height'}
              </span>
            </span>
            <svg class="calc-check-icon h-5 w-5 text-primary-600 hidden" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
          </label>
        ))}
      </div>
    </div>

    <!-- Condition -->
    <div>
      <label class="block text-sm font-medium text-gray-900 mb-3">2. Condition</label>
      <div class="grid grid-cols-2 gap-3" id="calc-condition-options">
        <label class="calc-condition-option relative flex cursor-pointer rounded-lg border border-gray-200 p-4 hover:border-primary-500 focus-within:ring-2 focus-within:ring-primary-500">
          <input type="radio" name="calc-condition" value="new" class="sr-only" />
          <span class="flex flex-1 flex-col">
            <span class="block text-sm font-semibold text-gray-900">New (One-Trip)</span>
            <span class="mt-1 text-xs text-gray-500">Like new, minimal use</span>
          </span>
          <svg class="calc-check-icon h-5 w-5 text-primary-600 hidden" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
          </svg>
        </label>
        <label class="calc-condition-option relative flex cursor-pointer rounded-lg border border-primary-500 bg-primary-50 p-4 hover:border-primary-500 focus-within:ring-2 focus-within:ring-primary-500">
          <input type="radio" name="calc-condition" value="used" class="sr-only" checked />
          <span class="flex flex-1 flex-col">
            <span class="block text-sm font-semibold text-gray-900">Used</span>
            <span class="mt-1 text-xs text-gray-500">Wind & watertight</span>
          </span>
          <svg class="calc-check-icon h-5 w-5 text-primary-600" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
          </svg>
        </label>
      </div>
    </div>

    <!-- Interest Type -->
    <div>
      <label class="block text-sm font-medium text-gray-900 mb-3">3. I want to</label>
      <div class="grid grid-cols-2 gap-3" id="calc-type-options">
        <label class="calc-type-option relative flex cursor-pointer rounded-lg border border-primary-500 bg-primary-50 p-4 hover:border-primary-500 focus-within:ring-2 focus-within:ring-primary-500">
          <input type="radio" name="calc-type" value="buy" class="sr-only" checked />
          <span class="flex flex-1 flex-col">
            <span class="block text-sm font-semibold text-gray-900">Buy</span>
            <span class="mt-1 text-xs text-gray-500">Own it outright</span>
          </span>
          <svg class="calc-check-icon h-5 w-5 text-primary-600" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
          </svg>
        </label>
        <label class="calc-type-option relative flex cursor-pointer rounded-lg border border-gray-200 p-4 hover:border-primary-500 focus-within:ring-2 focus-within:ring-primary-500">
          <input type="radio" name="calc-type" value="rent" class="sr-only" />
          <span class="flex flex-1 flex-col">
            <span class="block text-sm font-semibold text-gray-900">Rent</span>
            <span class="mt-1 text-xs text-gray-500">Month-to-month</span>
          </span>
          <svg class="calc-check-icon h-5 w-5 text-primary-600 hidden" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
          </svg>
        </label>
      </div>
    </div>

    <!-- Price Result -->
    <div id="calc-result" class="rounded-lg bg-gray-900 p-6 text-white">
      <div class="text-sm text-gray-400 mb-1">Estimated Price</div>
      <div class="flex items-baseline gap-2">
        <span id="calc-price" class="text-3xl font-bold">$3,000 - $3,600</span>
        <span id="calc-period" class="text-gray-400"></span>
      </div>
      <p id="calc-note" class="text-sm text-gray-400 mt-2">
        + Free delivery within 50km of Saskatoon
      </p>
      <a
        href={phoneLink}
        class="mt-4 w-full inline-flex items-center justify-center gap-2 rounded-lg bg-primary-600 px-6 py-3 text-base font-semibold text-white hover:bg-primary-700 transition-colors"
      >
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
        </svg>
        Get Exact Quote
      </a>
    </div>

    <p class="text-center text-xs text-gray-500">
      Prices vary based on availability and specific container condition. Call for current pricing.
    </p>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Rental prices (not in config, hardcoded for now)
    const rentalPrices: Record<string, { min: number; max: number }> = {
      '9ft': { min: 100, max: 125 },
      '20ft': { min: 150, max: 175 },
      '40ft': { min: 200, max: 250 },
      '40ft HC': { min: 225, max: 275 },
    };

    function updateOptionStyles(container: Element, inputName: string) {
      const options = container.querySelectorAll(`input[name="${inputName}"]`);
      options.forEach((input) => {
        const label = input.closest('label');
        const checkIcon = label?.querySelector('.calc-check-icon');
        if ((input as HTMLInputElement).checked) {
          label?.classList.remove('border-gray-200', 'bg-white');
          label?.classList.add('border-primary-500', 'bg-primary-50');
          checkIcon?.classList.remove('hidden');
        } else {
          label?.classList.add('border-gray-200', 'bg-white');
          label?.classList.remove('border-primary-500', 'bg-primary-50');
          checkIcon?.classList.add('hidden');
        }
      });
    }

    function updatePrice() {
      const sizeInput = document.querySelector('input[name="calc-size"]:checked') as HTMLInputElement;
      const conditionInput = document.querySelector('input[name="calc-condition"]:checked') as HTMLInputElement;
      const typeInput = document.querySelector('input[name="calc-type"]:checked') as HTMLInputElement;

      const priceEl = document.getElementById('calc-price');
      const periodEl = document.getElementById('calc-period');
      const noteEl = document.getElementById('calc-note');

      if (!sizeInput || !conditionInput || !typeInput || !priceEl || !periodEl || !noteEl) return;

      const isBuy = typeInput.value === 'buy';
      const isNew = conditionInput.value === 'new';
      const size = sizeInput.dataset.size || '20ft';

      if (isBuy) {
        const minPrice = isNew
          ? parseInt(sizeInput.dataset.newMin || '0')
          : parseInt(sizeInput.dataset.usedMin || '0');
        const maxPrice = isNew
          ? parseInt(sizeInput.dataset.newMax || '0')
          : parseInt(sizeInput.dataset.usedMax || '0');

        if (minPrice === 0 && maxPrice === 0) {
          priceEl.textContent = 'Call for Price';
          noteEl.textContent = `${isNew ? 'New' : 'Used'} ${size} containers - limited availability`;
        } else {
          priceEl.textContent = `$${minPrice.toLocaleString()} - $${maxPrice.toLocaleString()}`;
          noteEl.textContent = '+ Free delivery within 50km of Saskatoon';
        }
        periodEl.textContent = '';
      } else {
        // Rental pricing
        const rental = rentalPrices[size] || { min: 150, max: 200 };
        priceEl.textContent = `$${rental.min} - $${rental.max}`;
        periodEl.textContent = '/month';
        noteEl.textContent = 'Delivery & pickup included. No long-term contract required.';
      }
    }

    // Add event listeners to all option groups
    ['calc-size', 'calc-condition', 'calc-type'].forEach((name) => {
      const container = document.getElementById(`${name}-options`);
      if (!container) return;

      container.querySelectorAll(`input[name="${name}"]`).forEach((input) => {
        input.addEventListener('change', () => {
          updateOptionStyles(container, name);
          updatePrice();
        });
      });

      // Initialize styles
      updateOptionStyles(container, name);
    });

    // Initialize price
    updatePrice();
  });
</script>

<style>
  .calc-size-option:has(input:checked),
  .calc-condition-option:has(input:checked),
  .calc-type-option:has(input:checked) {
    border-color: var(--color-primary-500);
    background-color: var(--color-primary-50);
  }
</style>
