---
/**
 * QuickQuoteForm - Simplified 4-field form for higher conversion
 *
 * Research shows forms with 3-5 fields have significantly higher completion rates
 * than complex forms. This component captures essential info for follow-up.
 */
import { siteConfig } from '../config/site';

interface Props {
  title?: string;
  subtitle?: string;
  variant?: 'default' | 'compact' | 'inline';
  showInterestField?: boolean;
}

const {
  title = "Get a Free Quote",
  subtitle = "Tell us what you need and we'll get back to you within 2 hours during business hours.",
  variant = 'default',
  showInterestField = true,
} = Astro.props;

const isDev = import.meta.env.DEV;
const apiEndpoint = isDev ? 'http://localhost:3001/contact' : '/api/contact.php';

const containerClasses = {
  default: 'bg-accent-400 rounded-xl p-6 sm:p-8',
  compact: 'bg-gray-50 rounded-lg p-4 sm:p-6',
  inline: 'bg-white border border-gray-200 rounded-lg p-4',
};
---

<div class={`quick-quote-form ${containerClasses[variant]}`}>
  {title && (
    <div class="mb-6">
      <h3 class="text-xl font-bold text-gray-900">{title}</h3>
      {subtitle && (
        <p class="mt-2 text-gray-700 text-sm">{subtitle}</p>
      )}
    </div>
  )}

  <form id="quick-quote-form" class="space-y-4" data-endpoint={apiEndpoint}>
    <input type="hidden" name="formType" value="quick-quote" />

    <!-- Row 1: Name -->
    <div>
      <label for="qq-name" class="block text-sm font-medium text-gray-900">
        Name <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        name="name"
        id="qq-name"
        placeholder="Your name"
        required
        autocomplete="name"
        class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-3 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-base"
        aria-describedby="qq-name-error"
      />
      <p id="qq-name-error" class="mt-1 text-sm text-red-600 hidden" role="alert"></p>
    </div>

    <!-- Row 2: Email & Phone side by side on larger screens -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label for="qq-email" class="block text-sm font-medium text-gray-900">
          Email <span class="text-red-500">*</span>
        </label>
        <input
          type="email"
          name="email"
          id="qq-email"
          placeholder="you@example.com"
          required
          autocomplete="email"
          inputmode="email"
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-3 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-base"
          aria-describedby="qq-email-error"
        />
        <p id="qq-email-error" class="mt-1 text-sm text-red-600 hidden" role="alert"></p>
      </div>
      <div>
        <label for="qq-phone" class="block text-sm font-medium text-gray-900">
          Phone <span class="text-red-500">*</span>
        </label>
        <input
          type="tel"
          name="phone"
          id="qq-phone"
          placeholder="(306) 555-1234"
          required
          autocomplete="tel"
          inputmode="tel"
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-3 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-base"
          aria-describedby="qq-phone-error"
        />
        <p id="qq-phone-error" class="mt-1 text-sm text-red-600 hidden" role="alert"></p>
      </div>
    </div>

    <!-- Row 3: Interest (optional but helpful) -->
    {showInterestField && (
      <div>
        <label for="qq-interest" class="block text-sm font-medium text-gray-900">
          I'm interested in
        </label>
        <select
          name="interest"
          id="qq-interest"
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-3 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-base"
        >
          <option value="">Select an option (optional)</option>
          <option value="Buying a container">Buying a container</option>
          <option value="Renting a container">Renting a container</option>
          <option value="On-site storage">On-site storage at your facility</option>
          <option value="Not sure yet">Not sure yet - need advice</option>
        </select>
      </div>
    )}

    <!-- Row 4: Message (optional) -->
    <div>
      <label for="qq-message" class="block text-sm font-medium text-gray-900">
        Message <span class="text-gray-500 font-normal">(optional)</span>
      </label>
      <textarea
        name="message"
        id="qq-message"
        rows="2"
        placeholder="Any details about what you need..."
        class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-3 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-base resize-none"
      ></textarea>
    </div>

    <!-- Row 5: How did you find us (optional - for attribution tracking) -->
    <div>
      <label for="qq-referral-source" class="block text-sm font-medium text-gray-900">
        How did you hear about us? <span class="text-gray-500 font-normal">(optional)</span>
      </label>
      <select
        name="referralSource"
        id="qq-referral-source"
        class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-3 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-base"
      >
        <option value="">Select an option</option>
        <option value="Google Search">Google Search</option>
        <option value="AI Assistant">AI Assistant (ChatGPT, Perplexity, etc.)</option>
        <option value="Facebook">Facebook</option>
        <option value="Instagram">Instagram</option>
        <option value="Friend/Family">Friend or Family Referral</option>
        <option value="Saw Container/Truck">Saw Your Container or Truck</option>
        <option value="Returning Customer">Returning Customer</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <!-- Honeypot field for spam prevention -->
    <div class="hidden" aria-hidden="true">
      <label for="qq-website">Website</label>
      <input type="text" name="website_url" id="qq-website" tabindex="-1" autocomplete="off" />
    </div>

    <!-- Time-based validation -->
    <input type="hidden" name="_formLoadTime" class="form-load-time" value="" />

    <!-- Status message -->
    <div id="qq-status" class="hidden rounded-lg p-4" role="alert" aria-live="polite"></div>

    <!-- Submit button -->
    <div>
      <button
        type="submit"
        id="qq-submit-btn"
        class="w-full rounded-lg bg-gray-900 px-6 py-4 text-base font-semibold text-white shadow-sm transition-all hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <span id="qq-btn-text">Get My Free Quote</span>
        <span id="qq-btn-loading" class="hidden items-center justify-center">
          <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Sending...
        </span>
      </button>
    </div>

    <!-- Response time promise -->
    <p class="text-center text-sm text-gray-600">
      <svg class="inline-block h-4 w-4 mr-1 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      We respond within 2 hours during business hours (M-F 9-5)
    </p>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Set form load timestamp
    const formLoadTime = Date.now().toString();
    document.querySelectorAll('.form-load-time').forEach(input => {
      (input as HTMLInputElement).value = formLoadTime;
    });

    const form = document.getElementById('quick-quote-form') as HTMLFormElement;
    if (!form) return;

    const status = document.getElementById('qq-status') as HTMLDivElement;
    const submitBtn = document.getElementById('qq-submit-btn') as HTMLButtonElement;
    const btnText = document.getElementById('qq-btn-text') as HTMLSpanElement;
    const btnLoading = document.getElementById('qq-btn-loading') as HTMLSpanElement;
    const endpoint = form.dataset.endpoint || '/api/contact.php';

    // Real-time validation
    const nameInput = document.getElementById('qq-name') as HTMLInputElement;
    const emailInput = document.getElementById('qq-email') as HTMLInputElement;
    const phoneInput = document.getElementById('qq-phone') as HTMLInputElement;

    function validateField(input: HTMLInputElement, errorId: string) {
      const errorEl = document.getElementById(errorId);
      if (!errorEl) return true;

      let isValid = true;
      let message = '';

      if (input.required && !input.value.trim()) {
        isValid = false;
        message = 'This field is required';
      } else if (input.type === 'email' && input.value) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(input.value)) {
          isValid = false;
          message = 'Please enter a valid email address';
        }
      } else if (input.type === 'tel' && input.value) {
        const phoneDigits = input.value.replace(/\D/g, '');
        if (phoneDigits.length < 10) {
          isValid = false;
          message = 'Please enter a 10-digit phone number';
        }
      }

      if (!isValid) {
        input.setAttribute('aria-invalid', 'true');
        input.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        input.classList.remove('border-gray-300', 'focus:border-primary-500', 'focus:ring-primary-500');
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
      } else {
        input.setAttribute('aria-invalid', 'false');
        input.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        input.classList.add('border-gray-300', 'focus:border-primary-500', 'focus:ring-primary-500');
        errorEl.classList.add('hidden');
      }

      return isValid;
    }

    // Add blur validation
    nameInput?.addEventListener('blur', () => validateField(nameInput, 'qq-name-error'));
    emailInput?.addEventListener('blur', () => validateField(emailInput, 'qq-email-error'));
    phoneInput?.addEventListener('blur', () => validateField(phoneInput, 'qq-phone-error'));

    // Phone formatting
    phoneInput?.addEventListener('input', (e) => {
      const input = e.target as HTMLInputElement;
      const digits = input.value.replace(/\D/g, '');
      if (digits.length <= 10) {
        let formatted = '';
        if (digits.length > 0) formatted += '(' + digits.substring(0, 3);
        if (digits.length > 3) formatted += ') ' + digits.substring(3, 6);
        if (digits.length > 6) formatted += '-' + digits.substring(6, 10);
        input.value = formatted;
      }
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate all fields
      const nameValid = validateField(nameInput, 'qq-name-error');
      const emailValid = validateField(emailInput, 'qq-email-error');
      const phoneValid = validateField(phoneInput, 'qq-phone-error');

      if (!nameValid || !emailValid || !phoneValid) {
        // Focus first invalid field
        if (!nameValid) nameInput.focus();
        else if (!emailValid) emailInput.focus();
        else if (!phoneValid) phoneInput.focus();
        return;
      }

      const formData = new FormData(form);
      const data: Record<string, string> = {};
      formData.forEach((value, key) => {
        data[key] = value.toString();
      });

      // Show loading state
      submitBtn.disabled = true;
      btnText.classList.add('hidden');
      btnLoading.classList.remove('hidden');
      btnLoading.classList.add('flex');
      status.classList.add('hidden');

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          status.className = 'rounded-lg p-4 bg-green-50 text-green-800 border border-green-200';
          status.innerHTML = `
            <div class="flex items-start gap-3">
              <svg class="h-6 w-6 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div>
                <p class="font-semibold">Thanks! We got your message.</p>
                <p class="text-sm mt-1">We'll call or email you within 2 hours during business hours. If you need us sooner, call <a href="tel:18444732226" class="underline font-medium">1-844-473-2226</a>.</p>
              </div>
            </div>
          `;
          form.reset();
          // Reset form load time for next submission
          document.querySelectorAll('.form-load-time').forEach(input => {
            (input as HTMLInputElement).value = Date.now().toString();
          });
        } else {
          status.className = 'rounded-lg p-4 bg-red-50 text-red-800 border border-red-200';
          status.innerHTML = `
            <div class="flex items-center gap-2">
              <svg class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              ${result.message || 'Something went wrong. Please try again.'}
            </div>
          `;
        }
      } catch (error) {
        status.className = 'rounded-lg p-4 bg-red-50 text-red-800 border border-red-200';
        status.innerHTML = `
          <div class="flex items-center gap-2">
            <svg class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Unable to send. Please call us at <a href="tel:18444732226" class="underline font-medium">1-844-473-2226</a>.
          </div>
        `;
      } finally {
        submitBtn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
        btnLoading.classList.remove('flex');
        status.classList.remove('hidden');
        status.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    });
  });
</script>
