---
/**
 * Cookie Consent Component
 * GDPR/CCPA compliant cookie consent banner with granular preferences
 */
import { siteConfig } from '../config/site';
---

<!-- Cookie Consent Banner -->
<div
  id="cookie-banner"
  class="fixed inset-x-0 bottom-0 z-50 hidden transform transition-transform duration-300 translate-y-full"
  role="dialog"
  aria-modal="true"
  aria-labelledby="cookie-banner-title"
>
  <div class="bg-gray-900 shadow-2xl border-t border-gray-700">
    <div class="mx-auto max-w-7xl px-4 py-4 sm:px-6 lg:px-8">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div class="flex-1">
          <h2 id="cookie-banner-title" class="text-lg font-semibold text-white">
            We value your privacy
          </h2>
          <p class="mt-1 text-sm text-gray-300">
            We use cookies to enhance your browsing experience, analyze site traffic, and personalize content.
            By clicking "Accept All", you consent to our use of cookies.
            <a href="/privacy/" class="text-primary-400 hover:text-primary-300 underline">Learn more</a>
          </p>
        </div>
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
          <button
            id="cookie-settings-btn"
            type="button"
            class="inline-flex items-center justify-center rounded-lg border border-gray-600 bg-transparent px-4 py-2.5 text-sm font-medium text-white transition-colors hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-900"
          >
            Cookie Settings
          </button>
          <button
            id="cookie-reject-btn"
            type="button"
            class="inline-flex items-center justify-center rounded-lg border border-gray-600 bg-transparent px-4 py-2.5 text-sm font-medium text-white transition-colors hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-900"
          >
            Reject All
          </button>
          <button
            id="cookie-accept-btn"
            type="button"
            class="inline-flex items-center justify-center rounded-lg bg-primary-600 px-4 py-2.5 text-sm font-medium text-white shadow-sm transition-colors hover:bg-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-900"
          >
            Accept All
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cookie Preferences Modal -->
<div
  id="cookie-modal"
  class="fixed inset-0 z-[60] hidden"
  role="dialog"
  aria-modal="true"
  aria-labelledby="cookie-modal-title"
>
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" id="cookie-modal-backdrop"></div>

  <!-- Modal Content -->
  <div class="fixed inset-0 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
      <div class="relative w-full max-w-lg transform rounded-2xl bg-white shadow-2xl transition-all">
        <!-- Header -->
        <div class="border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <h3 id="cookie-modal-title" class="text-xl font-semibold text-gray-900">
              Cookie Preferences
            </h3>
            <button
              id="cookie-modal-close"
              type="button"
              class="rounded-lg p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500"
              aria-label="Close"
            >
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <p class="mt-1 text-sm text-gray-500">
            Manage your cookie preferences below. You can enable or disable different types of cookies.
          </p>
        </div>

        <!-- Cookie Options -->
        <div class="px-6 py-4 space-y-4 max-h-[60vh] overflow-y-auto">
          <!-- Necessary Cookies (Always On) -->
          <div class="rounded-lg border border-gray-200 bg-gray-50 p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <h4 class="font-medium text-gray-900">Essential Cookies</h4>
                  <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">
                    Always Active
                  </span>
                </div>
                <p class="mt-1 text-sm text-gray-600">
                  These cookies are necessary for the website to function and cannot be disabled. They are usually set in response to actions you take, such as setting your privacy preferences or filling in forms.
                </p>
              </div>
              <div class="ml-4 flex-shrink-0">
                <div class="relative inline-flex h-6 w-11 items-center rounded-full bg-green-600 cursor-not-allowed opacity-60">
                  <span class="inline-block h-4 w-4 transform rounded-full bg-white shadow-sm translate-x-6"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Analytics Cookies -->
          <div class="rounded-lg border border-gray-200 p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h4 class="font-medium text-gray-900">Analytics Cookies</h4>
                <p class="mt-1 text-sm text-gray-600">
                  These cookies help us understand how visitors interact with our website by collecting and reporting information anonymously. This helps us improve our site and services.
                </p>
              </div>
              <div class="ml-4 flex-shrink-0">
                <button
                  type="button"
                  role="switch"
                  aria-checked="false"
                  data-cookie-type="analytics"
                  class="cookie-toggle relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                >
                  <span class="cookie-toggle-dot inline-block h-4 w-4 transform rounded-full bg-white shadow-sm transition-transform translate-x-1"></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Marketing Cookies -->
          <div class="rounded-lg border border-gray-200 p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h4 class="font-medium text-gray-900">Marketing Cookies</h4>
                <p class="mt-1 text-sm text-gray-600">
                  These cookies are used to track visitors across websites to display relevant advertisements. They help us measure the effectiveness of our advertising campaigns.
                </p>
              </div>
              <div class="ml-4 flex-shrink-0">
                <button
                  type="button"
                  role="switch"
                  aria-checked="false"
                  data-cookie-type="marketing"
                  class="cookie-toggle relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                >
                  <span class="cookie-toggle-dot inline-block h-4 w-4 transform rounded-full bg-white shadow-sm transition-transform translate-x-1"></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Functional Cookies -->
          <div class="rounded-lg border border-gray-200 p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h4 class="font-medium text-gray-900">Functional Cookies</h4>
                <p class="mt-1 text-sm text-gray-600">
                  These cookies enable enhanced functionality and personalization, such as remembering your preferences and settings for future visits.
                </p>
              </div>
              <div class="ml-4 flex-shrink-0">
                <button
                  type="button"
                  role="switch"
                  aria-checked="false"
                  data-cookie-type="functional"
                  class="cookie-toggle relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                >
                  <span class="cookie-toggle-dot inline-block h-4 w-4 transform rounded-full bg-white shadow-sm transition-transform translate-x-1"></span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="border-t border-gray-200 px-6 py-4">
          <div class="flex flex-col gap-2 sm:flex-row sm:justify-end">
            <button
              id="cookie-reject-all-btn"
              type="button"
              class="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm transition-colors hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
            >
              Reject All
            </button>
            <button
              id="cookie-accept-selected-btn"
              type="button"
              class="inline-flex items-center justify-center rounded-lg bg-primary-600 px-4 py-2.5 text-sm font-medium text-white shadow-sm transition-colors hover:bg-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
            >
              Save Preferences
            </button>
          </div>
          <p class="mt-3 text-center text-xs text-gray-500">
            For more information, please read our <a href="/privacy/" class="text-primary-600 hover:text-primary-500 underline">Privacy Policy</a>.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cookie Settings Link (for footer or anywhere on the page) -->
<style is:global>
  .cookie-toggle[aria-checked="true"] {
    background-color: var(--color-primary-600, #d97706);
  }
  .cookie-toggle[aria-checked="true"] .cookie-toggle-dot {
    transform: translateX(1.25rem);
  }
</style>

<script is:inline>
(function() {
  'use strict';

  // Cookie consent storage key
  const CONSENT_KEY = 'cookie_consent';
  const CONSENT_VERSION = '1.0';

  // Elements
  const banner = document.getElementById('cookie-banner');
  const modal = document.getElementById('cookie-modal');
  const modalBackdrop = document.getElementById('cookie-modal-backdrop');
  const modalCloseBtn = document.getElementById('cookie-modal-close');
  const settingsBtn = document.getElementById('cookie-settings-btn');
  const acceptBtn = document.getElementById('cookie-accept-btn');
  const rejectBtn = document.getElementById('cookie-reject-btn');
  const rejectAllBtn = document.getElementById('cookie-reject-all-btn');
  const acceptSelectedBtn = document.getElementById('cookie-accept-selected-btn');
  const toggles = document.querySelectorAll('.cookie-toggle');

  // Default consent state
  const defaultConsent = {
    version: CONSENT_VERSION,
    timestamp: null,
    essential: true, // Always true
    analytics: false,
    marketing: false,
    functional: false
  };

  // Get stored consent
  function getStoredConsent() {
    try {
      const stored = localStorage.getItem(CONSENT_KEY);
      if (stored) {
        const consent = JSON.parse(stored);
        // Check version - if outdated, show banner again
        if (consent.version === CONSENT_VERSION) {
          return consent;
        }
      }
    } catch (e) {
      console.error('Error reading cookie consent:', e);
    }
    return null;
  }

  // Save consent
  function saveConsent(consent) {
    consent.timestamp = new Date().toISOString();
    consent.version = CONSENT_VERSION;
    localStorage.setItem(CONSENT_KEY, JSON.stringify(consent));
    applyConsent(consent);
  }

  // Apply consent settings (load/block scripts)
  function applyConsent(consent) {
    // Dispatch custom event for other scripts to listen to
    window.dispatchEvent(new CustomEvent('cookieConsentUpdated', { detail: consent }));

    // Analytics cookies - load GA and/or GTM
    if (consent.analytics) {
      loadGoogleTagManager();
      loadGoogleAnalytics();
    }

    // Marketing cookies
    if (consent.marketing) {
      // Marketing scripts can be added here
      // GTM can also handle marketing tags if configured
    }
  }

  // Load Google Tag Manager
  function loadGoogleTagManager() {
    const html = document.documentElement;
    const gtmEnabled = html.dataset.gtmEnabled === 'true';
    const gtmId = html.dataset.gtmId;

    if (!gtmEnabled || !gtmId || window.gtmLoaded) return;

    // GTM script
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer',gtmId);

    // Add noscript iframe to body
    const noscript = document.createElement('noscript');
    const iframe = document.createElement('iframe');
    iframe.src = `https://www.googletagmanager.com/ns.html?id=${gtmId}`;
    iframe.height = '0';
    iframe.width = '0';
    iframe.style.display = 'none';
    iframe.style.visibility = 'hidden';
    noscript.appendChild(iframe);
    document.body.insertBefore(noscript, document.body.firstChild);

    window.gtmLoaded = true;
    console.log('GTM loaded:', gtmId);
  }

  // Load Google Analytics 4
  function loadGoogleAnalytics() {
    const html = document.documentElement;
    const gaEnabled = html.dataset.gaEnabled === 'true';
    const gaId = html.dataset.gaId;

    if (!gaEnabled || !gaId || window.gaLoaded) return;

    // If GTM is also enabled, GA might be configured through GTM
    // But we can still load GA directly for redundancy or standalone use

    // Create and load GA script
    const script = document.createElement('script');
    script.async = true;
    script.src = `https://www.googletagmanager.com/gtag/js?id=${gaId}`;
    document.head.appendChild(script);

    // Initialize gtag
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', gaId, { anonymize_ip: true });

    window.gaLoaded = true;
    console.log('GA4 loaded:', gaId);
  }

  // Show banner with animation
  function showBanner() {
    banner.classList.remove('hidden');
    // Use requestAnimationFrame to avoid forced reflow
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        banner.classList.remove('translate-y-full');
      });
    });
  }

  // Hide banner with animation
  function hideBanner() {
    banner.classList.add('translate-y-full');
    setTimeout(() => {
      banner.classList.add('hidden');
    }, 300);
  }

  // Show modal
  function showModal() {
    // Load current preferences into toggles
    const consent = getStoredConsent() || defaultConsent;
    toggles.forEach(toggle => {
      const type = toggle.dataset.cookieType;
      const isEnabled = consent[type] || false;
      toggle.setAttribute('aria-checked', isEnabled.toString());
    });

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Focus first toggle for accessibility
    setTimeout(() => {
      modalCloseBtn.focus();
    }, 100);
  }

  // Hide modal
  function hideModal() {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  }

  // Get current toggle states
  function getToggledConsent() {
    const consent = { ...defaultConsent };
    toggles.forEach(toggle => {
      const type = toggle.dataset.cookieType;
      consent[type] = toggle.getAttribute('aria-checked') === 'true';
    });
    return consent;
  }

  // Accept all cookies
  function acceptAll() {
    const consent = {
      ...defaultConsent,
      analytics: true,
      marketing: true,
      functional: true
    };
    saveConsent(consent);
    hideBanner();
    hideModal();
  }

  // Reject all optional cookies
  function rejectAll() {
    saveConsent({ ...defaultConsent });
    hideBanner();
    hideModal();
  }

  // Save selected preferences
  function saveSelected() {
    const consent = getToggledConsent();
    saveConsent(consent);
    hideBanner();
    hideModal();
  }

  // Toggle click handler
  function handleToggleClick(e) {
    const toggle = e.currentTarget;
    const isChecked = toggle.getAttribute('aria-checked') === 'true';
    toggle.setAttribute('aria-checked', (!isChecked).toString());
  }

  // Initialize
  function init() {
    const consent = getStoredConsent();

    if (consent) {
      // Consent already given, apply it
      applyConsent(consent);
    } else {
      // No consent, show banner
      showBanner();
    }

    // Event listeners
    acceptBtn?.addEventListener('click', acceptAll);
    rejectBtn?.addEventListener('click', rejectAll);
    settingsBtn?.addEventListener('click', showModal);
    modalCloseBtn?.addEventListener('click', hideModal);
    modalBackdrop?.addEventListener('click', hideModal);
    rejectAllBtn?.addEventListener('click', rejectAll);
    acceptSelectedBtn?.addEventListener('click', saveSelected);

    toggles.forEach(toggle => {
      toggle.addEventListener('click', handleToggleClick);
    });

    // Escape key to close modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        hideModal();
      }
    });

    // Expose function to open settings from anywhere (e.g., footer link)
    window.openCookieSettings = showModal;
  }

  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
