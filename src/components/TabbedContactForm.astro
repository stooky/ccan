---
import { siteConfig } from '../config/site';

// Determine API endpoint based on environment
const isDev = import.meta.env.DEV;
const apiEndpoint = isDev ? 'http://localhost:3001/contact' : '/api/contact.php';
---

<div class="tabbed-form">
  <!-- Tab Headers -->
  <div class="flex border-b border-gray-200" role="tablist" aria-label="Contact form options">
    <button
      type="button"
      id="tab-quote"
      class="tab-btn flex-1 py-4 px-6 text-center font-semibold border-b-2 border-primary-600 text-primary-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-inset"
      data-tab="quote"
      role="tab"
      aria-selected="true"
      aria-controls="panel-quote"
      tabindex="0"
    >
      Quote
    </button>
    <button
      type="button"
      id="tab-message"
      class="tab-btn flex-1 py-4 px-6 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-inset"
      data-tab="message"
      role="tab"
      aria-selected="false"
      aria-controls="panel-message"
      tabindex="-1"
    >
      Quick Message
    </button>
  </div>

  <!-- Quote Form -->
  <div id="panel-quote" class="tab-panel bg-accent-400 rounded-b-xl p-6 sm:p-8" role="tabpanel" aria-labelledby="tab-quote">
    <div class="mb-6">
      <h3 class="text-xl font-bold text-gray-900">Help Sam Do What Sam Does Best—Find You!</h3>
      <p class="mt-2 text-gray-700 text-sm">
        Please double-check your phone number and email address. Accurate info ensures that Sam <em>can</em> find you quickly and easily!
      </p>
      <p class="mt-2 text-gray-700 text-sm">
        If you don't hear from us within 24 hours, give us a call at <strong>{siteConfig.contact.phone}</strong>.
      </p>
      <p class="mt-1 text-gray-700 text-sm">
        After all, we're just a <em>flock away</em>—and Sam <em>can</em> make it happen!
      </p>
    </div>

    <form id="quote-form" class="space-y-4" data-endpoint={apiEndpoint}>
      <input type="hidden" name="formType" value="quote" />

      <div>
        <label for="quote-name" class="block text-sm font-medium text-gray-900">Name</label>
        <input
          type="text"
          name="name"
          id="quote-name"
          placeholder="Name"
          required
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        />
      </div>

      <div>
        <label for="quote-email" class="block text-sm font-medium text-gray-900">Email</label>
        <input
          type="email"
          name="email"
          id="quote-email"
          placeholder="Email"
          required
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        />
      </div>

      <div>
        <label for="quote-phone" class="block text-sm font-medium text-gray-900">Phone</label>
        <input
          type="tel"
          name="phone"
          id="quote-phone"
          placeholder="Phone Number"
          required
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        />
      </div>

      <div>
        <label for="quote-size" class="block text-sm font-medium text-gray-900">Container Size</label>
        <select
          name="containerSize"
          id="quote-size"
          required
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        >
          <option value="20ft standard container">20ft standard container</option>
          <option value="40ft standard container">40ft standard container</option>
          <option value="40ft high cube container">40ft high cube container</option>
          <option value="Not sure">Not sure</option>
        </select>
      </div>

      <div>
        <label for="quote-condition" class="block text-sm font-medium text-gray-900">Condition</label>
        <select
          name="condition"
          id="quote-condition"
          required
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        >
          <option value="New">New</option>
          <option value="Used">Used</option>
          <option value="Either">Either</option>
        </select>
      </div>

      <div>
        <label for="quote-intention" class="block text-sm font-medium text-gray-900">Intention</label>
        <select
          name="intention"
          id="quote-intention"
          required
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        >
          <option value="Purchase">Purchase</option>
          <option value="Rent">Rent</option>
          <option value="On-Site Storage">On-Site Storage</option>
          <option value="Not sure yet">Not sure yet</option>
        </select>
      </div>

      <div>
        <label for="quote-delivery" class="block text-sm font-medium text-gray-900">Delivery</label>
        <select
          name="delivery"
          id="quote-delivery"
          required
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        >
          <option value="Self Pick Up">Self Pick Up</option>
          <option value="Delivery Required">Delivery Required</option>
        </select>
      </div>

      <!-- Delivery Address Section (shown when Delivery Required is selected) -->
      <div id="delivery-address-section" class="hidden space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-900 mb-2">Location Type</label>
          <div class="flex gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input
                type="radio"
                name="locationType"
                value="Urban"
                class="h-4 w-4 text-primary-600 border-gray-300 focus:ring-primary-500"
              />
              <span class="text-sm text-gray-700">Urban</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input
                type="radio"
                name="locationType"
                value="Rural"
                class="h-4 w-4 text-primary-600 border-gray-300 focus:ring-primary-500"
              />
              <span class="text-sm text-gray-700">Rural</span>
            </label>
          </div>
        </div>

        <!-- Urban Address Fields -->
        <div id="urban-fields" class="hidden space-y-4">
          <div>
            <label for="quote-street" class="block text-sm font-medium text-gray-900">Street Address</label>
            <input
              type="text"
              name="streetAddress"
              id="quote-street"
              placeholder="123 Main Street"
              class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="quote-city" class="block text-sm font-medium text-gray-900">City</label>
              <input
                type="text"
                name="city"
                id="quote-city"
                placeholder="Saskatoon"
                class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
              />
            </div>
            <div>
              <label for="quote-postal" class="block text-sm font-medium text-gray-900">Postal Code</label>
              <input
                type="text"
                name="postalCode"
                id="quote-postal"
                placeholder="S7K 0A1"
                class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
              />
            </div>
          </div>
        </div>

        <!-- Rural Address Fields -->
        <div id="rural-fields" class="hidden space-y-4">
          <div>
            <label for="quote-land-location" class="block text-sm font-medium text-gray-900">Land Location</label>
            <input
              type="text"
              name="landLocation"
              id="quote-land-location"
              placeholder="e.g., NE 14-36-5 W3"
              class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
          <div>
            <label for="quote-directions" class="block text-sm font-medium text-gray-900">Additional Directions and Instructions</label>
            <textarea
              name="additionalDirections"
              id="quote-directions"
              rows="3"
              placeholder="e.g., Turn left at the grain elevator, 2km down the gravel road..."
              class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            ></textarea>
          </div>
        </div>
      </div>

      <div>
        <label for="quote-message" class="block text-sm font-medium text-gray-900">Message</label>
        <textarea
          name="message"
          id="quote-message"
          rows="4"
          placeholder="Message"
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        ></textarea>
      </div>

      <div>
        <label for="quote-referral-source" class="block text-sm font-medium text-gray-900">How did you hear about us? <span class="text-gray-500 font-normal">(optional)</span></label>
        <select
          name="referralSource"
          id="quote-referral-source"
          class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        >
          <option value="">Select an option</option>
          <option value="Google Search">Google Search</option>
          <option value="AI Assistant">AI Assistant (ChatGPT, Perplexity, etc.)</option>
          <option value="Facebook">Facebook</option>
          <option value="Instagram">Instagram</option>
          <option value="Friend/Family">Friend or Family Referral</option>
          <option value="Saw Container/Truck">Saw Your Container or Truck</option>
          <option value="Returning Customer">Returning Customer</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <!-- Honeypot field for spam prevention -->
      <div class="hidden" aria-hidden="true">
        <label for="quote-website">Website</label>
        <input type="text" name="website_url" id="quote-website" tabindex="-1" autocomplete="off" />
      </div>

      <!-- Time-based validation -->
      <input type="hidden" name="_formLoadTime" class="form-load-time" value="" />

      <!-- Status message -->
      <div id="quote-status" class="hidden rounded-lg p-4" role="alert" aria-live="polite"></div>

      <div>
        <button
          type="submit"
          id="quote-submit-btn"
          class="w-full rounded-lg bg-gray-800 px-6 py-3 text-base font-medium text-white shadow-sm transition-colors hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span id="quote-btn-text">Send</span>
          <span id="quote-btn-loading" class="hidden">
            <svg class="animate-spin inline-block h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Sending...
          </span>
        </button>
      </div>
    </form>
  </div>

  <!-- Quick Message Form -->
  <div id="panel-message" class="tab-panel hidden bg-gray-50 rounded-b-xl p-6 sm:p-8" role="tabpanel" aria-labelledby="tab-message">
    <div class="mb-6">
      <h3 class="text-xl font-bold text-gray-900">Send Us a Quick Message</h3>
      <p class="mt-2 text-gray-600 text-sm">
        Have a question? Fill out the form below and we'll get back to you as soon as possible.
      </p>
    </div>

    <form id="message-form" class="space-y-4" data-endpoint={apiEndpoint}>
      <input type="hidden" name="formType" value="message" />

      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label for="msg-firstName" class="block text-sm font-medium text-gray-700">First Name</label>
          <input
            type="text"
            name="firstName"
            id="msg-firstName"
            required
            class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
          />
        </div>
        <div>
          <label for="msg-lastName" class="block text-sm font-medium text-gray-700">Last Name</label>
          <input
            type="text"
            name="lastName"
            id="msg-lastName"
            required
            class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
          />
        </div>
      </div>

      <div>
        <label for="msg-email" class="block text-sm font-medium text-gray-700">Email</label>
        <input
          type="email"
          name="email"
          id="msg-email"
          required
          class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        />
      </div>

      <div>
        <label for="msg-phone" class="block text-sm font-medium text-gray-700">
          Phone <span class="text-gray-500">(optional)</span>
        </label>
        <input
          type="tel"
          name="phone"
          id="msg-phone"
          class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        />
      </div>

      <div>
        <label for="msg-message" class="block text-sm font-medium text-gray-700">Message</label>
        <textarea
          name="message"
          id="msg-message"
          rows="5"
          required
          class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        ></textarea>
      </div>

      <div>
        <label for="msg-referral-source" class="block text-sm font-medium text-gray-700">How did you hear about us? <span class="text-gray-500">(optional)</span></label>
        <select
          name="referralSource"
          id="msg-referral-source"
          class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 shadow-sm focus:border-primary-500 focus:ring-primary-500"
        >
          <option value="">Select an option</option>
          <option value="Google Search">Google Search</option>
          <option value="AI Assistant">AI Assistant (ChatGPT, Perplexity, etc.)</option>
          <option value="Facebook">Facebook</option>
          <option value="Instagram">Instagram</option>
          <option value="Friend/Family">Friend or Family Referral</option>
          <option value="Saw Container/Truck">Saw Your Container or Truck</option>
          <option value="Returning Customer">Returning Customer</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <!-- Honeypot field for spam prevention -->
      <div class="hidden" aria-hidden="true">
        <label for="msg-website">Website</label>
        <input type="text" name="website_url" id="msg-website" tabindex="-1" autocomplete="off" />
      </div>

      <!-- Time-based validation -->
      <input type="hidden" name="_formLoadTime" class="form-load-time" value="" />

      <!-- Status message -->
      <div id="message-status" class="hidden rounded-lg p-4" role="alert" aria-live="polite"></div>

      <div>
        <button
          type="submit"
          id="message-submit-btn"
          class="w-full rounded-lg bg-primary-600 px-6 py-3 text-base font-medium text-white shadow-sm transition-colors hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span id="message-btn-text">Send Message</span>
          <span id="message-btn-loading" class="hidden">
            <svg class="animate-spin inline-block h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Sending...
          </span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Set form load timestamp for time-based spam detection
    const formLoadTime = Date.now().toString();
    document.querySelectorAll('.form-load-time').forEach(input => {
      (input as HTMLInputElement).value = formLoadTime;
    });

    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn') as NodeListOf<HTMLButtonElement>;
    const tabPanels = document.querySelectorAll('.tab-panel');

    function switchTab(btn: HTMLButtonElement) {
      const tabId = btn.getAttribute('data-tab');

      // Update tab buttons
      tabBtns.forEach(b => {
        b.classList.remove('border-primary-600', 'text-primary-600');
        b.classList.add('border-transparent', 'text-gray-500');
        b.setAttribute('aria-selected', 'false');
        b.setAttribute('tabindex', '-1');
      });
      btn.classList.remove('border-transparent', 'text-gray-500');
      btn.classList.add('border-primary-600', 'text-primary-600');
      btn.setAttribute('aria-selected', 'true');
      btn.setAttribute('tabindex', '0');

      // Update panels
      tabPanels.forEach(panel => {
        panel.classList.add('hidden');
      });
      document.getElementById(`panel-${tabId}`)?.classList.remove('hidden');
    }

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn));

      // Keyboard navigation for tabs
      btn.addEventListener('keydown', (e) => {
        const tabs = Array.from(tabBtns);
        const currentIndex = tabs.indexOf(btn);

        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
          e.preventDefault();
          const nextIndex = (currentIndex + 1) % tabs.length;
          tabs[nextIndex].focus();
          switchTab(tabs[nextIndex]);
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          e.preventDefault();
          const prevIndex = (currentIndex - 1 + tabs.length) % tabs.length;
          tabs[prevIndex].focus();
          switchTab(tabs[prevIndex]);
        } else if (e.key === 'Home') {
          e.preventDefault();
          tabs[0].focus();
          switchTab(tabs[0]);
        } else if (e.key === 'End') {
          e.preventDefault();
          tabs[tabs.length - 1].focus();
          switchTab(tabs[tabs.length - 1]);
        }
      });
    });

    // Delivery dropdown toggle
    const deliverySelect = document.getElementById('quote-delivery') as HTMLSelectElement;
    const deliverySection = document.getElementById('delivery-address-section');
    const urbanFields = document.getElementById('urban-fields');
    const ruralFields = document.getElementById('rural-fields');
    const locationRadios = document.querySelectorAll('input[name="locationType"]');

    if (deliverySelect && deliverySection) {
      deliverySelect.addEventListener('change', () => {
        if (deliverySelect.value === 'Delivery Required') {
          deliverySection.classList.remove('hidden');
        } else {
          deliverySection.classList.add('hidden');
          // Reset location type selection
          locationRadios.forEach(radio => {
            (radio as HTMLInputElement).checked = false;
          });
          urbanFields?.classList.add('hidden');
          ruralFields?.classList.add('hidden');
        }
      });
    }

    // Urban/Rural toggle
    locationRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        const value = (e.target as HTMLInputElement).value;
        if (value === 'Urban') {
          urbanFields?.classList.remove('hidden');
          ruralFields?.classList.add('hidden');
        } else {
          urbanFields?.classList.add('hidden');
          ruralFields?.classList.remove('hidden');
        }
      });
    });

    // Form submission handler
    function setupForm(formId: string, statusId: string, submitBtnId: string, btnTextId: string, btnLoadingId: string) {
      const form = document.getElementById(formId) as HTMLFormElement;
      const status = document.getElementById(statusId) as HTMLDivElement;
      const submitBtn = document.getElementById(submitBtnId) as HTMLButtonElement;
      const btnText = document.getElementById(btnTextId) as HTMLSpanElement;
      const btnLoading = document.getElementById(btnLoadingId) as HTMLSpanElement;

      if (!form) return;

      const endpoint = form.dataset.endpoint || '/api/contact.php';

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const data: Record<string, string> = {};
        formData.forEach((value, key) => {
          data[key] = value.toString();
        });

        // Show loading state
        submitBtn.disabled = true;
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        status.classList.add('hidden');

        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            status.className = 'rounded-lg p-4 bg-green-50 text-green-800 border border-green-200';
            status.innerHTML = `
              <div class="flex items-center">
                <svg class="h-5 w-5 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                ${result.message}
              </div>
            `;
            form.reset();
          } else {
            status.className = 'rounded-lg p-4 bg-red-50 text-red-800 border border-red-200';
            status.innerHTML = `
              <div class="flex items-center">
                <svg class="h-5 w-5 mr-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                ${result.message}
              </div>
            `;
          }
        } catch (error) {
          status.className = 'rounded-lg p-4 bg-red-50 text-red-800 border border-red-200';
          status.innerHTML = `
            <div class="flex items-center">
              <svg class="h-5 w-5 mr-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              Unable to send message. Please try again or contact us directly.
            </div>
          `;
          console.error('Form submission error:', error);
        } finally {
          submitBtn.disabled = false;
          btnText.classList.remove('hidden');
          btnLoading.classList.add('hidden');
          status.classList.remove('hidden');
          status.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    }

    // Initialize both forms
    setupForm('quote-form', 'quote-status', 'quote-submit-btn', 'quote-btn-text', 'quote-btn-loading');
    setupForm('message-form', 'message-status', 'message-submit-btn', 'message-btn-text', 'message-btn-loading');
  });
</script>
